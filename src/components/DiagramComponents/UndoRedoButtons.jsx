import React from "react";
import { useDiagram } from "./DiagramContext";
import useKeyboardShortcuts from "./hooks/useKeyboardShortcuts";

/**
 * Undo/Redo Î≤ÑÌäº Ïª¥Ìè¨ÎÑåÌä∏
 * DiagramContextÏùò undo/redo Í∏∞Îä•ÏùÑ UIÎ°ú Ï†úÍ≥µÌï©ÎãàÎã§.
 *
 * @param {Object} props - Ïª¥Ìè¨ÎÑåÌä∏ ÏÜçÏÑ±
 * @param {string} props.position - Î≤ÑÌäº ÏúÑÏπò ("top-right" | "top-left" | "bottom-right" | "bottom-left" | "center")
 * @param {string} props.className - Ï∂îÍ∞Ä CSS ÌÅ¥ÎûòÏä§
 * @param {string} props.buttonClassName - Í∞úÎ≥Ñ Î≤ÑÌäºÏóê Ï†ÅÏö©Ìï† CSS ÌÅ¥ÎûòÏä§
 * @param {boolean} props.showLabels - Î≤ÑÌäºÏóê ÌÖçÏä§Ìä∏ ÎùºÎ≤® ÌëúÏãú Ïó¨Î∂Ä
 * @param {string} props.size - Î≤ÑÌäº ÌÅ¨Í∏∞ ("sm" | "md" | "lg")
 * @param {string} props.variant - Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÌòï ("primary" | "secondary" | "ghost" | "success" | "warning" | "danger" | "info" | "dark" | "light" | "outline" | "gradient" | "neon" | "glass" | "rainbow" | "sunset" | "ocean" | "forest" | "cosmic" | "retro" | "minimal" | "cyberpunk" | "glow" | "holographic" | "aurora" | "metallic" | "fire" | "ice" | "luxury")
 * @param {boolean} props.enableKeyboardShortcuts - ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ ÌôúÏÑ±Ìôî Ïó¨Î∂Ä
 * @param {Object} props.customLabels - Ïª§Ïä§ÌÖÄ ÎùºÎ≤® ({ undo: "Ï∑®ÏÜå", redo: "Î≥µÏõê" })
 * @param {boolean} props.iconOnly - ÏïÑÏù¥ÏΩòÎßå ÌëúÏãú (showLabelsÎ≥¥Îã§ Ïö∞ÏÑ†ÏàúÏúÑ ÎÜíÏùå)
 * @param {boolean} props.vertical - ÏÑ∏Î°ú Î∞∞Ïπò Ïó¨Î∂Ä
 * @param {string} props.spacing - Î≤ÑÌäº Í∞ÑÍ≤© (Ïòà: "gap-2", "gap-4")
 * @param {string} props.rounded - Î™®ÏÑúÎ¶¨ Îë•Í∏ÄÍ∏∞ (Ïòà: "rounded-lg", "rounded-full")
 * @param {Object} props.customStyle - ÏôÑÏ†Ñ Ïª§Ïä§ÌÖÄ Ïä§ÌÉÄÏùº ({ undo: "bg-red-500 text-white", redo: "bg-green-500 text-white" })
 * @param {string} props.containerClass - Ïª®ÌÖåÏù¥ÎÑàÏóê Ï∂îÍ∞ÄÌï† TailwindCSS ÌÅ¥ÎûòÏä§
 * @param {string} props.undoClass - Undo Î≤ÑÌäºÏóê Ï∂îÍ∞ÄÌï† TailwindCSS ÌÅ¥ÎûòÏä§
 * @param {string} props.redoClass - Redo Î≤ÑÌäºÏóê Ï∂îÍ∞ÄÌï† TailwindCSS ÌÅ¥ÎûòÏä§
 * @param {boolean} props.hoverEffects - Í∏∞Î≥∏ Ìò∏Î≤Ñ Ìö®Í≥º ÌôúÏÑ±Ìôî Ïó¨Î∂Ä
 */
const UndoRedoButtons = ({
  position = "top-right", // "top-right" | "top-left" | "bottom-right" | "bottom-left" | "center"
  className = "",
  buttonClassName = "",
  showLabels = false, // Î≤ÑÌäºÏóê ÌÖçÏä§Ìä∏ ÎùºÎ≤® ÌëúÏãú Ïó¨Î∂Ä
  size = "md", // "sm" | "md" | "lg"
  variant = "primary", // "primary" | "secondary" | "ghost" | "success" | "warning" | "danger" | "info" | "dark" | "light" | "outline" | "gradient" | "neon" | "glass" | "rainbow" | "sunset" | "ocean" | "forest" | "cosmic" | "retro" | "minimal" | "cyberpunk" | "glow" | "holographic" | "aurora" | "metallic" | "fire" | "ice" | "luxury"
  enableKeyboardShortcuts = true, // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ ÌôúÏÑ±Ìôî Ïó¨Î∂Ä
  customLabels = null, // { undo: "Ï∑®ÏÜå", redo: "Î≥µÏõê" } ÌòïÌÉúÎ°ú Ïª§Ïä§ÌÖÄ ÎùºÎ≤® ÏÑ§Ï†ï
  iconOnly = false, // trueÏùº Îïå ÏïÑÏù¥ÏΩòÎßå ÌëúÏãú (showLabelsÎ≥¥Îã§ Ïö∞ÏÑ†ÏàúÏúÑ ÎÜíÏùå)
  vertical = false, // ÏÑ∏Î°ú Î∞∞Ïπò Ïó¨Î∂Ä
  spacing = "gap-2", // Î≤ÑÌäº Í∞ÑÍ≤© Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï
  rounded = "rounded-lg", // Î™®ÏÑúÎ¶¨ Îë•Í∏ÄÍ∏∞ Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï
  // üé® TailwindCSS ÏûêÏú† Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï ÏòµÏÖò
  customStyle = null, // { undo: "bg-red-500 text-white", redo: "bg-green-500 text-white" } ÌòïÌÉúÎ°ú ÏôÑÏ†Ñ Ïª§Ïä§ÌÖÄ
  containerClass = "", // Ïª®ÌÖåÏù¥ÎÑàÏóê Ï∂îÍ∞ÄÌï† TailwindCSS ÌÅ¥ÎûòÏä§
  undoClass = "", // Undo Î≤ÑÌäºÏóê Ï∂îÍ∞ÄÌï† TailwindCSS ÌÅ¥ÎûòÏä§
  redoClass = "", // Redo Î≤ÑÌäºÏóê Ï∂îÍ∞ÄÌï† TailwindCSS ÌÅ¥ÎûòÏä§
  hoverEffects = true, // Í∏∞Î≥∏ Ìò∏Î≤Ñ Ìö®Í≥º ÌôúÏÑ±Ìôî Ïó¨Î∂Ä
}) => {
  const { undo, redo, getDiagramStats } = useDiagram();
  const stats = getDiagramStats();

  // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ ÌôúÏÑ±Ìôî
  const { getShortcutInfo } = useKeyboardShortcuts({
    enabled: enableKeyboardShortcuts,
  });
  const shortcutInfo = getShortcutInfo();

  // ÏúÑÏπòÎ≥Ñ Ïä§ÌÉÄÏùº
  const positionStyles = {
    "top-right": "fixed top-4 right-4 z-50",
    "top-left": "fixed top-4 left-4 z-50",
    "bottom-right": "fixed bottom-4 right-4 z-50",
    "bottom-left": "fixed bottom-4 left-4 z-50",
    center: "absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50",
  };

  // ÌÅ¨Í∏∞Î≥Ñ Ïä§ÌÉÄÏùº - ÎùºÎ≤® Ïó¨Î∂ÄÏóê Îî∞Îùº Îã§Î•¥Í≤å Ï†ÅÏö©
  const sizeStyles = {
    sm: showLabels ? "px-3 py-2 text-sm min-w-[90px] h-8" : "w-8 h-8 text-sm",
    md: showLabels ? "px-4 py-2 text-base min-w-[110px] h-10" : "w-10 h-10 text-base",
    lg: showLabels ? "px-5 py-3 text-lg min-w-[130px] h-12" : "w-12 h-12 text-lg",
  };

  // Î≥ÄÌòïÎ≥Ñ Ïä§ÌÉÄÏùº - Îçî ÎßéÏùÄ ÏòµÏÖò Ï∂îÍ∞Ä
  const variantStyles = {
    primary: {
      base: "bg-blue-600 hover:bg-blue-700 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    secondary: {
      base: "bg-gray-600 hover:bg-gray-700 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-200 text-gray-400 cursor-not-allowed",
    },
    ghost: {
      base: "bg-white/90 hover:bg-gray-100 text-gray-700 shadow-md border border-gray-200 hover:shadow-lg",
      disabled: "bg-white/50 text-gray-400 cursor-not-allowed border-gray-100",
    },
    success: {
      base: "bg-green-600 hover:bg-green-700 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    warning: {
      base: "bg-yellow-600 hover:bg-yellow-700 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    danger: {
      base: "bg-red-600 hover:bg-red-700 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    info: {
      base: "bg-cyan-600 hover:bg-cyan-700 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    dark: {
      base: "bg-gray-800 hover:bg-gray-900 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    light: {
      base: "bg-gray-100 hover:bg-gray-200 text-gray-800 shadow-md border border-gray-300 hover:shadow-lg",
      disabled: "bg-gray-50 text-gray-400 cursor-not-allowed border-gray-200",
    },
    outline: {
      base: "bg-transparent hover:bg-blue-50 text-blue-600 border-2 border-blue-600 hover:border-blue-700",
      disabled: "bg-transparent text-gray-400 border-2 border-gray-300 cursor-not-allowed",
    },
    gradient: {
      base: "bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    neon: {
      base: "bg-black text-cyan-400 border border-cyan-400 shadow-lg shadow-cyan-400/50 hover:shadow-cyan-400/70 hover:text-cyan-300 hover:border-cyan-300",
      disabled: "bg-gray-800 text-gray-600 border-gray-600 cursor-not-allowed",
    },
    glass: {
      base: "bg-white/20 backdrop-blur-md border border-white/30 text-gray-800 hover:bg-white/30 shadow-lg hover:shadow-xl",
      disabled: "bg-white/10 backdrop-blur-md border border-white/20 text-gray-400 cursor-not-allowed",
    },
    rainbow: {
      base: "bg-gradient-to-r from-red-500 via-yellow-500 via-green-500 via-blue-500 to-purple-500 hover:from-red-600 hover:via-yellow-600 hover:via-green-600 hover:via-blue-600 hover:to-purple-600 text-white shadow-lg hover:shadow-xl animate-pulse",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    sunset: {
      base: "bg-gradient-to-br from-orange-400 via-pink-500 to-red-500 hover:from-orange-500 hover:via-pink-600 hover:to-red-600 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    ocean: {
      base: "bg-gradient-to-br from-blue-400 via-cyan-500 to-teal-500 hover:from-blue-500 hover:via-cyan-600 hover:to-teal-600 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    forest: {
      base: "bg-gradient-to-br from-green-400 via-emerald-500 to-teal-600 hover:from-green-500 hover:via-emerald-600 hover:to-teal-700 text-white shadow-lg hover:shadow-xl",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    cosmic: {
      base: "bg-gradient-to-r from-purple-800 via-violet-900 to-purple-800 hover:from-purple-700 hover:via-violet-800 hover:to-purple-700 text-white shadow-lg shadow-purple-500/30 hover:shadow-purple-500/50 border border-purple-500/20",
      disabled: "bg-gray-800 text-gray-500 cursor-not-allowed",
    },
    retro: {
      base: "bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 hover:from-pink-600 hover:via-purple-600 hover:to-indigo-600 text-white shadow-lg hover:shadow-xl transform hover:rotate-1 transition-transform",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    minimal: {
      base: "bg-gray-50 hover:bg-gray-100 text-gray-600 border border-gray-200 hover:border-gray-300 shadow-sm hover:shadow-md",
      disabled: "bg-gray-50 text-gray-400 border-gray-200 cursor-not-allowed",
    },
    cyberpunk: {
      base: "bg-black text-green-400 border border-green-400 shadow-lg shadow-green-400/30 hover:shadow-green-400/50 hover:text-green-300 hover:border-green-300 font-mono",
      disabled: "bg-gray-900 text-gray-600 border-gray-600 cursor-not-allowed",
    },
    glow: {
      base: "bg-white text-blue-600 border-2 border-blue-400 shadow-lg shadow-blue-400/50 hover:shadow-blue-400/80 hover:shadow-2xl hover:border-blue-300 hover:text-blue-500",
      disabled: "bg-gray-100 text-gray-400 border-gray-300 cursor-not-allowed",
    },
    holographic: {
      base: "bg-gradient-to-br from-pink-400 via-purple-400 via-indigo-400 to-cyan-400 hover:from-pink-300 hover:via-purple-300 hover:via-indigo-300 hover:to-cyan-300 text-white shadow-xl hover:shadow-2xl border border-white/20 backdrop-blur-sm",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    aurora: {
      base: "bg-gradient-to-r from-green-300 via-blue-500 to-purple-600 hover:from-green-400 hover:via-blue-600 hover:to-purple-700 text-white shadow-lg hover:shadow-xl animate-pulse",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    metallic: {
      base: "bg-gradient-to-b from-gray-300 via-gray-100 to-gray-400 hover:from-gray-200 hover:via-gray-50 hover:to-gray-300 text-gray-800 shadow-lg hover:shadow-xl border border-gray-400",
      disabled: "bg-gray-200 text-gray-500 cursor-not-allowed",
    },
    fire: {
      base: "bg-gradient-to-r from-red-600 via-orange-500 to-yellow-500 hover:from-red-700 hover:via-orange-600 hover:to-yellow-600 text-white shadow-lg shadow-orange-500/50 hover:shadow-orange-500/70",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
    ice: {
      base: "bg-gradient-to-br from-blue-100 via-cyan-100 to-blue-200 hover:from-blue-50 hover:via-cyan-50 hover:to-blue-100 text-blue-800 shadow-lg shadow-blue-200/50 hover:shadow-blue-200/70 border border-blue-200",
      disabled: "bg-gray-100 text-gray-400 cursor-not-allowed",
    },
    luxury: {
      base: "bg-gradient-to-r from-yellow-400 via-yellow-500 to-yellow-600 hover:from-yellow-300 hover:via-yellow-400 hover:to-yellow-500 text-yellow-900 shadow-lg shadow-yellow-400/50 hover:shadow-yellow-400/70 border border-yellow-300",
      disabled: "bg-gray-300 text-gray-500 cursor-not-allowed",
    },
  };

  // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
  const handleUndoKeyDown = (event) => {
    if (event.key === "Enter" || event.key === " ") {
      event.preventDefault();
      if (stats.canUndo) {
        undo();
      }
    }
  };

  const handleRedoKeyDown = (event) => {
    if (event.key === "Enter" || event.key === " ") {
      event.preventDefault();
      if (stats.canRedo) {
        redo();
      }
    }
  };

  // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
  const handleUndoClick = () => {
    if (stats.canUndo) {
      undo();
    }
  };

  const handleRedoClick = () => {
    if (stats.canRedo) {
      redo();
    }
  };

  // ÎùºÎ≤® ÌÖçÏä§Ìä∏ Í≤∞Ï†ï
  const labels = customLabels || { undo: "Ïã§ÌñâÏ∑®ÏÜå", redo: "Îã§ÏãúÏã§Ìñâ" };
  const shouldShowLabels = showLabels && !iconOnly;

  // ÌäπÎ≥ÑÌïú Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥ºÎ•º ÏúÑÌïú Ï∂îÍ∞Ä ÌÅ¥ÎûòÏä§
  const getAnimationClasses = () => {
    switch (variant) {
      case "neon":
      case "cyberpunk":
        return "hover:animate-pulse";
      case "rainbow":
        return "animate-pulse hover:animate-bounce";
      case "cosmic":
        return "hover:animate-pulse";
      case "retro":
        return "hover:rotate-1 hover:scale-110";
      case "glass":
        return "hover:backdrop-blur-lg";
      case "glow":
        return "hover:animate-pulse";
      case "holographic":
        return "hover:animate-bounce";
      case "aurora":
        return "animate-pulse hover:animate-spin";
      case "fire":
        return "hover:animate-pulse";
      case "luxury":
        return "hover:animate-bounce hover:rotate-2";
      default:
        return "";
    }
  };

  const baseButtonStyle = `
    ${sizeStyles[size]}
    ${rounded}
    transition-all
    duration-300
    flex
    items-center
    justify-center
    font-medium
    focus:outline-none
    focus:ring-2
    focus:ring-blue-500
    focus:ring-offset-2
    hover:scale-105
    active:scale-95
    transform
    ${getAnimationClasses()}
    ${buttonClassName}
  `;

  const getButtonStyle = (isEnabled, buttonType = null, customButtonClass = "") => {
    // Ïª§Ïä§ÌÖÄ Ïä§ÌÉÄÏùºÏù¥ Ï†úÍ≥µÎêú Í≤ΩÏö∞ Ïö∞ÏÑ† Ï†ÅÏö©
    if (customStyle && customStyle[buttonType]) {
      return `${baseButtonStyle} ${customStyle[buttonType]} ${customButtonClass}`;
    }

    const variant_ = variantStyles[variant];
    const baseStyle = isEnabled ? variant_.base : variant_.disabled;

    // Ìò∏Î≤Ñ Ìö®Í≥º ÎπÑÌôúÏÑ±Ìôî ÏòµÏÖò
    const finalStyle = hoverEffects ? baseStyle : baseStyle.replace(/hover:[^\s]+/g, "");

    return `${baseButtonStyle} ${finalStyle} ${customButtonClass}`;
  };

  return (
    <div
      className={`${positionStyles[position]} flex ${
        vertical ? "flex-col" : "flex-row"
      } ${spacing} ${containerClass} ${className}`}
    >
      {/* Undo Î≤ÑÌäº */}
      <button
        type="button"
        className={getButtonStyle(stats.canUndo, "undo", undoClass)}
        onClick={handleUndoClick}
        onKeyDown={handleUndoKeyDown}
        disabled={!stats.canUndo}
        tabIndex={0}
        aria-label={`Ïã§ÌñâÏ∑®ÏÜå ${stats.canUndo ? "(ÏÇ¨Ïö©Í∞ÄÎä•)" : "(ÏÇ¨Ïö©Î∂àÍ∞Ä)"}`}
        title={`${labels.undo} (${shortcutInfo.undo}) ${stats.canUndo ? "" : "- Ïã§ÌñâÏ∑®ÏÜåÌï† ÏûëÏóÖÏù¥ ÏóÜÏäµÎãàÎã§"}`}
      >
        {shouldShowLabels ? (
          <span className="flex items-center gap-1 whitespace-nowrap">
            <svg
              className="w-4 h-4 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"
              />
            </svg>
            <span className="text-sm font-medium">{labels.undo}</span>
          </span>
        ) : (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"
            />
          </svg>
        )}
      </button>

      {/* Redo Î≤ÑÌäº */}
      <button
        type="button"
        className={getButtonStyle(stats.canRedo, "redo", redoClass)}
        onClick={handleRedoClick}
        onKeyDown={handleRedoKeyDown}
        disabled={!stats.canRedo}
        tabIndex={0}
        aria-label={`Îã§ÏãúÏã§Ìñâ ${stats.canRedo ? "(ÏÇ¨Ïö©Í∞ÄÎä•)" : "(ÏÇ¨Ïö©Î∂àÍ∞Ä)"}`}
        title={`${labels.redo} (${shortcutInfo.redo}) ${stats.canRedo ? "" : "- Îã§ÏãúÏã§ÌñâÌï† ÏûëÏóÖÏù¥ ÏóÜÏäµÎãàÎã§"}`}
      >
        {shouldShowLabels ? (
          <span className="flex items-center gap-1 whitespace-nowrap">
            <svg
              className="w-4 h-4 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"
              />
            </svg>
            <span className="text-sm font-medium">{labels.redo}</span>
          </span>
        ) : (
          <svg
            className="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"
            />
          </svg>
        )}
      </button>
    </div>
  );
};

export default UndoRedoButtons;
